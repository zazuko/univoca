PREFIX hydra: <http://www.w3.org/ns/hydra/core#>
PREFIX time: <http://www.w3.org/2006/time#>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX meta: <https://krr.triply.cc/krr/sameas-meta/def/>
PREFIX qudt: <http://qudt.org/schema/qudt/>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
PREFIX schema: <http://schema.org/>
PREFIX dcterms: <http://purl.org/dc/terms/>
PREFIX dash: <http://datashapes.org/dash#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX sh: <http://www.w3.org/ns/shacl#>
prefix univoca: <https://cube.link/univoca/>
prefix sh1: <https://forms.hypermedia.app/shaperone#>
prefix iso6391: <http://lexvo.org/id/iso639-1/>

<#New>
  a sh:NodeShape ;
  hydra:apiDocumentation </api> ;
  sh:targetClass univoca:SharedDimension.created ;
  sh1:xoneDiscriminator univoca:createAs ;
  sh:property
    [
      sh:path univoca:createAs ;
      sh:minCount 1 ;
      sh:maxCount 1 ;
      sh:in ( "New dimension" "Import" ) ;
      sh:defaultValue "New dimension" ;
      sh:group _:defaultGroup ;
    ] ;
  sh:xone
    (
      [
        a sh:NodeShape ;
        # sh:closed true ;
        # sh:ignoredProperties (sh:property) ;
        sh:property
          [
            sh:path univoca:createAs ;
            sh:hasValue "Import" ;
            dash:hidden true ;
            sh:group _:defaultGroup ;
          ],
          [
            sh:name "Exported dimension" ;
            sh:path </api#export> ;
            sh:minCount 1 ;
            sh:maxCount 1 ;
            sh:order 5 ;
            dash:editor sh1:FileUpload ;
            sh:group _:defaultGroup ;
          ] ;
      ]
      [
        a sh:NodeShape ;
        # TODO SHACL test ton confirm sh:closed is not necessary
        # sh:closed true ;
        # sh:ignoredProperties (rdf:type) ;
        sh:and (<>) ;
        sh:property
          [
            sh:path univoca:createAs ;
            sh:hasValue "New dimension" ;
            dash:hidden true ;
            sh:group _:defaultGroup ;
          ],
          [
            sh:name "Identifier" ;
            sh:description "A lowercase, alphanumeric value which identifies a shared dimension" ;
            sh:path dcterms:identifier ;
            sh:order 0 ;
            sh:minCount 1 ;
            sh:maxCount 1 ;
            sh:pattern "^[a-z0-9-]+$" ;
            sh:group _:defaultGroup ;
          ] ;
      ]
    ) ;
.

<>
  sh:targetClass univoca:SharedDimension ;
  sh:property
    [
      sh:name "Name" ;
      sh:path schema:name ;
      sh:uniqueLang true ;
      sh:minCount 1 ;
      sh:maxCount 4 ;
      sh:languageIn ( "de" "fr" "it" "rm" "en" ) ;
      sh:order 10 ;
      sh:group _:defaultGroup ;
    ],
    [
      sh:name 'Valid from' ;
      sh:path schema:validFrom ;
      sh:maxCount 1 ;
      sh:datatype xsd:dateTime ;
    # TODO defaultValue: $rdf.literal(new Date().toISOString(), xsd.dateTime),
      sh:order 20 ;
      sh:group _:defaultGroup ;
    ],
    [
      sh:name 'Valid to' ;
      sh:path schema:validThrough ;
      sh:maxCount 1 ;
      sh:datatype xsd:dateTime ;
      sh:order 25 ;
      sh:group _:defaultGroup ;
    ],
    [
      sh:name 'Default metadata' ;
      sh:description "Metadata copied to cube's metadata when this dimension is selected" ;
      sh:path sh:property ;
      sh:minCount 1 ;
      sh:maxCount 1 ;
      sh:nodeKind sh:BlankNodeOrIRI ;
      sh:defaultValue [] ;
      sh:order 30 ;
      sh:group _:defaultGroup ;
      sh:node _:metadataShape ;
    ],
    [
      sh:name 'Term properties' ;
      sh:description 'Additional properties for Shared Terms' ;
      sh:path schema:additionalProperty ;
      sh:order 40 ;
      sh:nodeKind sh:BlankNodeOrIRI ;
      sh:group _:propertyGroup ;
      sh:node _:termProperties ;
    ] ;
.

_:defaultGroup rdfs:label "Dimension" .
_:propertyGroup rdfs:label "Term properties" .

_:metadataShape
  sh:property
    [
      sh:name 'Name' ;
      sh:path schema:name ;
      sh:uniqueLang true ;
      sh:maxCount 4 ;
      sh:languageIn ( "de" "fr" "it" "rm" "en" ) ; # TODO remove duplication
      sh:order 10 ;
    ],
    [
      sh:name 'Scale type' ;
      sh:path qudt:scaleType ;
      sh:in ( qudt:NominalScale qudt:OrdinalScale ) ;
      sh:maxCount 1 ;
      sh:defaultValue qudt:NominalScale ;
      sh:order 20 ;
    ],
    [
      sh:name "Data kind" ;
      sh:path meta:dataKind ;
      sh:maxCount 1 ;
      sh:nodeKind sh:BlankNodeOrIRI ;
      sh:order 30 ;
      sh:node
        [
          sh:property
            [
              sh:name "Choose type" ;
              sh:path rdf:type ;
              sh:minCount 1 ;
              sh:maxCount 1 ;
              sh:nodeKind sh:IRI ;
              dash:editor dash:EnumSelectEditor ;
              sh:in ( schema:GeoCoordinates schema:GeoShape time:GeneralDateTimeDescription ) ;
              sh:order 10 ;
            ],
            [
              sh:name "Time precision" ;
              sh:path time:unitType ;
              sh:maxCount 1 ;
              sh:order 20 ;
              sh:nodeKind sh:IRI ;
              sh1:if
                [
                  sh:path rdf:type ;
                  sh:hasValue time:GeneralDateTimeDescription ;
                ] ;
              sh:in
                (
                  time:unitYear
                  time:unitMonth
                  time:unitWeek
                  time:unitDay
                  time:unitHour
                  time:unitMinute
                  time:unitSecond
                )
            ] ;
        ] ;
    ] ;
.

qudt:NominalScale rdfs:label "Nominal"@en .
qudt:OrdinalScale rdfs:label "Ordinal"@en .
time:unit rdfs:label "Year"@en .
time:unit rdfs:label "Month"@en .
time:unit rdfs:label "Week"@en .
time:unit rdfs:label "Day"@en .
time:unit rdfs:label "Hour"@en .
time:unit rdfs:label "Minute"@en .
time:unit rdfs:label "Second"@en .

_:termProperties
  sh1:xoneDiscriminator univoca:dynamicPropertyType ;
  sh:property
    [
      sh:name "Name" ;
      sh:path rdfs:label ;
      sh:minCount 1 ;
      sh:maxCount 1 ;
      sh:order 5 ;
    ],
    [
      sh:name "Predicate" ;
      sh:path univoca:dynamicPropertyType ;
      sh:minCount 1 ;
      sh:maxCount 1 ;
      sh:in ( 'Literal' 'Shared Term' 'Lang String' ) ;
      sh:order 20 ;
    ],
    [
      sh:name 'Required' ;
      sh:path hydra:required ;
      sh:minCount 1 ;
      sh:maxCount 1 ;
      sh:datatype xsd:boolean ;
      sh:defaultValue false ;
      sh:order 15 ;
    ],
    [
      sh:name 'Allow multiple' ;
      sh:path schema:multipleValues ;
      sh:minCount 1 ;
      sh:maxCount 1 ;
      sh:datatype xsd:boolean ;
      sh:defaultValue false ;
      sh:order 15 ;
    ] ;
  sh:xone
    (
      [
        sh:closed true ;
        sh:ignoredProperties _:commonProperties ;
        sh:property
          [
            sh:path univoca:dynamicPropertyType ;
            sh:hasValue "Literal" ;
            dash:hidden true ;
          ],
          [
            sh:name "Data type" ;
            sh:path sh:datatype ;
            sh:in () ; # TODO
            sh:minCount 1 ;
            sh:maxCount 1 ;
            sh:nodeKind sh:IRI ;
            sh:order 30 ;
          ] ;
      ]
      [
        sh:closed true ;
        sh:ignoredProperties _:commonProperties ;
        sh:property
          [
            sh:path univoca:dynamicPropertyType ;
            sh:hasValue "Shared Term" ;
            dash:hidden true ;
          ],
          [
            sh:name "Shared dimension" ;
            sh:path sh:class ;
            dash:editor dash:AutoCompleteEditor ;
            hydra:collection </term-sets> ; # TODO all dimensions?
            sh:minCount 1 ;
            sh:maxCount 1 ;
            sh:nodeKind sh:IRI ;
            sh:order 30 ;
          ] ;
      ]
      [
        sh:closed true ;
        sh:ignoredProperties _:commonProperties ;
        sh:property
          [
            sh:path univoca:dynamicPropertyType ;
            sh:hasValue "Lang String" ;
            dash:hidden true ;
          ],
          [
            sh:name "Languages" ;
            sh:path sh:languageIn ;
            dash:editor sh1:CheckboxListEditor ; # TODO editor ns?
            sh:in
              (
                # TODO languages to a collection
                iso6391:de
                iso6391:fr
                iso6391:it
                iso6391:rm
                iso6391:en
              ) ;
            sh:order 30 ;
          ] ;
      ]
    ) ;
.

_:commonProperties
  rdf:first hydra:required ;
  rdf:rest
    (
      rdf:predicate rdfs:label schema:multipleValues
    ) .

iso6391:de rdfs:label "German"@en .
iso6391:fr rdfs:label "French"@en .
iso6391:it rdfs:label "Italian"@en .
iso6391:en rdfs:label "English"@en .
iso6391:rm rdfs:label "Romansh"@en .
